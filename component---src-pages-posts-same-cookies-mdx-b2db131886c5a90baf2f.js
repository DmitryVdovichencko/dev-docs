(window.webpackJsonp=window.webpackJsonp||[]).push([[10,14],{"5UI+":function(e,t,a){"use strict";a.r(t),a.d(t,"_frontmatter",(function(){return m})),a.d(t,"default",(function(){return d}));var n=a("zLVn"),c=(a("q1tI"),a("7ljp")),o=a("q52W"),m={title:"Разбираемся с атрибутом SameSite cookies ",date:"2020-12-20",tags:["js","ru"]},s={_frontmatter:m};function d(e){var t=e.components,a=Object(n.a)(e,["components"]);return Object(c.mdx)("wrapper",Object.assign({},s,a,{components:t,mdxType:"MDXLayout"}),Object(c.mdx)("h1",null,"Разбираемся с атрибутом ",Object(c.mdx)("inlineCode",{parentName:"h1"},"SameSite")," ",Object(c.mdx)("strong",{parentName:"h1"},"cookies")),Object(c.mdx)(o.a,{url:"same-cookies/cookie-hero.jpg",mdxType:"Picture"}),Object(c.mdx)("p",null,"Перевод статьи ",Object(c.mdx)("a",Object.assign({parentName:"p"},{href:"https://web.dev/authors/rowan_m/"}),"Rowan Merewood")," ",Object(c.mdx)("a",Object.assign({parentName:"p"},{href:"https://web.dev/samesite-cookies-explained/?utm_source=devtools"}),"SameSite cookies explained")),Object(c.mdx)("p",null,"Защитите свой сайт, узнав как явно определить кросс-сайтовые cookies."),Object(c.mdx)("p",null,Object(c.mdx)("inlineCode",{parentName:"p"},"Cookies")," являются одним из способов хранения состояния на веб-сайтах. Многие годы их возможности росли и развивались, при этом оставляя веб-платформу с некоторыми устаревшими проблемами. Чтобы это исправить, браузеры (включая Chrome, Firefox и Edge) изменили свое поведение в сторону защиты приватных данных пользователей."),Object(c.mdx)("p",null,"Каждый ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," представляет собой пару ключ-значение ",Object(c.mdx)("inlineCode",{parentName:"p"},"key = value")," с определенным набором атрибутов, которые контролируют когда и где будет использоваться ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie"),". Возможно, вы уже использовали эти атрибуты, чтобы например установить срок действия ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie"),", или передачу только по HTTPS. Сервера устанавливают ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," отправляя специальный заголовок ",Object(c.mdx)("inlineCode",{parentName:"p"},"Set-Cookie")," в ответе. За всеми подробностями можно обратиться к спецификации RFC6265bis, но вот краткий обзор того, как это работает."),Object(c.mdx)("p",null,'Допустим, у вас есть блог, где вы хотите показывать промо "Что нового" своим подписчикам. Пользователь может пропустить промо, и вряд ли после этого захочет увидеть его снова, по крайней мере, на некоторое время. Вы можете записать эту настройку в ',Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," и установить его срок действия в 1 месяц (2,600,000 сек), а также отправлять его только по HTTPS. В этом случае заголовок будет выглядеть так:"),Object(c.mdx)("pre",{className:"shiki",style:{backgroundColor:"#0F111A"}},Object(c.mdx)("code",{parentName:"pre"},Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFCB6B"}}),"Set"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"-"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Cookie"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),": "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"promo_shown"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#F78C6C"}}),"1"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),";"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}})," "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Max"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"-"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Age"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#F78C6C"}}),"2600000"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),";"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}})," "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Secure"))),Object(c.mdx)(o.a,{url:"same-cookies/set-cookie-response-header.png",title:"Сервера устанавливают cookies, используя заголовок Set-Cookie",mdxType:"Picture"}),Object(c.mdx)("p",null,"Когда ваш посетитель откроет страницу, удовлетворяющую этим требованиям, т.е. соединение защищено и  ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," не старше месяца, браузер отправит этот заголовок в своем запросе: "),Object(c.mdx)("pre",{className:"shiki",style:{backgroundColor:"#0F111A"}},Object(c.mdx)("code",{parentName:"pre"},Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Cookie"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),": "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"promo_shown"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#F78C6C"}}),"1"))),Object(c.mdx)(o.a,{url:"same-cookies/cookie-request-header.png",title:"Ваш браузер отправляет cookies обратно в заголовке Cookie",mdxType:"Picture"}),Object(c.mdx)("p",null,"Вы также можете добавлять и смотреть ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," доступные на сайте используя ",Object(c.mdx)("inlineCode",{parentName:"p"},"document.cookie"),".\nПрисваивание значения ",Object(c.mdx)("inlineCode",{parentName:"p"},"document.cookie")," создаст или перезапишет ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," с этим ключом. Например, попробуйте выполнить следующее в JavaScript консоли своего браузера: "),Object(c.mdx)("pre",{className:"shiki",style:{backgroundColor:"#0F111A"}},Object(c.mdx)("code",{parentName:"pre"},Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),"document"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"."),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),"cookie "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}})," "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),'"'),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C3E88D"}}),"promo_shown=1; Max-Age=2600000; Secure"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),'"'),"\n",Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#464B5D"}}),'// "promo_shown=1; Max-Age=2600000; Secure"'))),Object(c.mdx)("p",null,"Чтение ",Object(c.mdx)("inlineCode",{parentName:"p"},"document.cookie")," выведет все ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," доступные в текущем контексте, разделив их ",Object(c.mdx)("inlineCode",{parentName:"p"},";")),Object(c.mdx)("pre",{className:"shiki",style:{backgroundColor:"#0F111A"}},Object(c.mdx)("code",{parentName:"pre"},Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),"document"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"."),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),"cookie"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),";"),"\n",Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#464B5D"}}),'// "promo_shown=1; color_theme=peachpuff; sidebar_loc=left"'))),Object(c.mdx)(o.a,{url:"same-cookies/document-cookie.png",title:"JavaScript получает доступ к cookies с помощью document.cookie",mdxType:"Picture"}),Object(c.mdx)("p",null,"Если вы попробуете выполнить это на одном из популярных сайтов, то заметите, что большинство из них устанавливают значительно больше чем 3 ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies"),". Чаще всего, эти ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," отправляются в каждом запросе к домену, что приводит к ряду последствий. Обычно, для пользователей, ограничение исходящего трафика более строгое чем входящего. Так что, все излишние издержки на трафик исходящих запросов приводят к потерям в скорости. Будьте консервативными к числу и размеру ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies"),", которые вы устанавливаете. Используйте атрибут ",Object(c.mdx)("inlineCode",{parentName:"p"},"Max-Age"),", чтобы убедиться, что ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," не хранятся дольше чем необходимо.  "),Object(c.mdx)("h2",null,"Какие ",Object(c.mdx)("inlineCode",{parentName:"h2"},"cookies")," являются основными а какие сторонними?"),Object(c.mdx)("p",null,"Если вернуться к тем популярным сайтам на которые мы смотрели выше, вы, возможно, заметили что ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," представлены для разных доменов, а не только для того, на котором вы находитесь. "),Object(c.mdx)("p",null,Object(c.mdx)("strong",{parentName:"p"},Object(c.mdx)("inlineCode",{parentName:"strong"},"Cookies")," домен которых совпадает с текущим доменом из адресной строки браузера являются основными.")),Object(c.mdx)("p",null,Object(c.mdx)("strong",{parentName:"p"},"Соответственно, ",Object(c.mdx)("inlineCode",{parentName:"strong"},"Cookies")," домен которых отличается от текущего  являются сторонними.")),Object(c.mdx)("p",null,"Эти определения не являются абсолютными, они зависят от окружения пользователя: один и тот же ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," может быть как основным так и сторонним в зависимости от сайта, на котором находится пользователь в текущий момент."),Object(c.mdx)(o.a,{url:"same-cookies/cross-site-set-cookie-response-header.png",title:"Cookies могут приходить с множества разных доменов на одной странице.",mdxType:"Picture"}),Object(c.mdx)("p",null,"Продолжим с примером блога, допустим в одном из постов есть прикольная картинка с котэ и она хостится на ",Object(c.mdx)("inlineCode",{parentName:"p"},"/blog/img/amazing-cat.png"),". Поскольку картинка очень крутая, другой пользователь захотел использовать ее у себя на сайте. Если, пользователь уже посещал ваш блог, и у него есть ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," ",Object(c.mdx)("inlineCode",{parentName:"p"},"promo-shown"),", то когда он захочет посмотреть на картинку с котэ на другом сайте ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," будет прикреплен к запросу на получение картинки. Это определенно никому не нужно, т.к. ",Object(c.mdx)("inlineCode",{parentName:"p"},"promo_shown")," не используется на другом сайте, это излишняя нагрузка на запрос"),Object(c.mdx)("p",null,'Если это незапланированный эффект, зачем вам это делать? Существует механизм, позволяющий сайтам хранить\nсостояние, когда они используются в стороннем контексте. Например, вы добавили видео с YouTube на своем сайте. В плеере, посетитель увидит кнопку "Посмотреть позже". Если ваш посетитель уже залогинен на YouTube, то его сессия доступна во встроенном плеере через сторонние ',Object(c.mdx)("inlineCode",{parentName:"p"},"cookies"),'. Это значит, что кнопка "Посмотреть позже" просто сохранит видео, вместо запроса на логин или редиректа на YouTube.'),Object(c.mdx)(o.a,{url:"same-cookies/cross-site-cookie-request-header.png",title:"Сookie в стороннем контексте отправляются при посещении разных страниц.",mdxType:"Picture"}),Object(c.mdx)("p",null,"Одна из традиционных особенностей веба в том, что веб, по умолчанию, привык быть открытым. Поэтому, так много людей могут создавать приложения и размещать контент. Однако, эта особенность приводит к появлению ряда проблем в безопасности и приватности данных пользователя. Атаки фальсификации межсайтовых запросов (CSRF - Cross-Site Request Forgery) основаны на том факте, что ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," прикрепляются к каждому запросу, в независимости от того, кто является инициатором запроса. Например, если вы зашли на ",Object(c.mdx)("inlineCode",{parentName:"p"},"evil.example"),", то он может сделать запрос на ",Object(c.mdx)("inlineCode",{parentName:"p"},"your-blog.example")," и ваш браузер спокойненько прикрепит соответствующие ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies"),". И если ваш блог не заботится о проверке запросов то ",Object(c.mdx)("inlineCode",{parentName:"p"},"evil.example")," может спровоцировать действия типа удаления постов, или размещения собственного контента. "),Object(c.mdx)("p",null,"Пользователи также становятся более уязвимыми, от того как ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," используются для отслеживания их активности по разным сайтам. Тем не менее, до сих пор, отсутствовал способ явно заявить о намерениях использования ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies"),". Ваш ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," ",Object(c.mdx)("inlineCode",{parentName:"p"},"promo_shown")," должен отправляться только в основном контексте, учитывая при этом ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," сессии для встраиваемых виджетов, которые позволяют хранить состояние авторизации других сайтов в стороннем контексте.  "),Object(c.mdx)("h2",null,"Объявляем об использовании ",Object(c.mdx)("inlineCode",{parentName:"h2"},"cookies")," с атрибутом ",Object(c.mdx)("inlineCode",{parentName:"h2"},"SameSite")),Object(c.mdx)("p",null,"Включение атрибута ",Object(c.mdx)("inlineCode",{parentName:"p"},"SameSite")," (определенного в RFC6265bis) позволяет вам определить: должен ли ваш ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," использоваться только в основном или ",Object(c.mdx)("inlineCode",{parentName:"p"},"same-site")," контексте. Полезно понимать что вообще здесь значит ",Object(c.mdx)("inlineCode",{parentName:"p"},"site"),". ",Object(c.mdx)("inlineCode",{parentName:"p"},"Site")," - сочетание суффикса домена и части домена перед ним. Например, ",Object(c.mdx)("inlineCode",{parentName:"p"},"www.web.dev")," домен - часть сайта ",Object(c.mdx)("inlineCode",{parentName:"p"},"web.dev")),Object(c.mdx)("p",null,Object(c.mdx)("strong",{parentName:"p"},"Ключевое понятие:")),Object(c.mdx)("p",null,"Если пользователь находится на ",Object(c.mdx)("inlineCode",{parentName:"p"},"www.web.dev")," и запрашивает изображение с ",Object(c.mdx)("inlineCode",{parentName:"p"},"static.web.dev")," то это является ",Object(c.mdx)("inlineCode",{parentName:"p"},"same-site")," запросом."),Object(c.mdx)("p",null,"Список суффиксов доменов определен здесь, так что это не только домены высшего уровня типа ",Object(c.mdx)("inlineCode",{parentName:"p"},".com"),"  но также и сервисы например ",Object(c.mdx)("inlineCode",{parentName:"p"},"github.io"),". Это позволяет считать ",Object(c.mdx)("inlineCode",{parentName:"p"},"your-project.github.io")," и ",Object(c.mdx)("inlineCode",{parentName:"p"},"my-project.github.io")," разными сайтами."),Object(c.mdx)("p",null,Object(c.mdx)("strong",{parentName:"p"},"Ключевое понятие:")),Object(c.mdx)("p",null,"Если пользователь на ",Object(c.mdx)("inlineCode",{parentName:"p"},"your-project.github.io")," и запрашивает изображение с ",Object(c.mdx)("inlineCode",{parentName:"p"},"my-project.github.io")," то это\nмежсайтовый (cross-site) запрос."),Object(c.mdx)("p",null,"Включение атрибута ",Object(c.mdx)("inlineCode",{parentName:"p"},"SameSite")," в ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," предоставляет три возможных варианта управления поведением. Вы можете не определять аттрибут, либо использовать ",Object(c.mdx)("inlineCode",{parentName:"p"},"Strict")," или ",Object(c.mdx)("inlineCode",{parentName:"p"},"Lax")," для ограничения передачи ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie"),"только на собственном сайте."),Object(c.mdx)("p",null,"Если вы назначите ",Object(c.mdx)("inlineCode",{parentName:"p"},"SameSite")," значение ",Object(c.mdx)("inlineCode",{parentName:"p"},"Strict"),", ваш ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," будет пересылаться только в основном контексте. Для пользователя, это означает что ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," будет отправлен только сайту из адресной строки браузера. Так что, если ",Object(c.mdx)("inlineCode",{parentName:"p"},"promo_shown")," ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," будет определен следующим образом:"),Object(c.mdx)("pre",{className:"shiki",style:{backgroundColor:"#0F111A"}},Object(c.mdx)("code",{parentName:"pre"},Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFCB6B"}}),"Set"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"-"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Cookie"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),": "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"promo_shown"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#F78C6C"}}),"1"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),";"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}})," "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"SameSite"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Strict"))),Object(c.mdx)("p",null,"Когда ваш пользователь находится у вас на сайте, ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," будет отправлен в запросе, как и ожидается. С другой стороны, когда пользователь пройдет по ссылке на ваш сайт, например, с другого сайта или из email от своего друга, в инициализирующем запросе ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," отправлен не будет. Это хорошо в том случае, если ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," относятся к функционалу за пределами начальной навигации, такому как смена пароля или создание заказа. Но, это слишком строго для ",Object(c.mdx)("inlineCode",{parentName:"p"},"promo_shown"),". Если ваш пользователь пройдет по ссылке на сайт, он бы хотел чтобы ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," был отправлен и, соответственно его выбор не смотреть промо сработал корректно. "),Object(c.mdx)("p",null,"Здесь нам поможет ",Object(c.mdx)("inlineCode",{parentName:"p"},"SameSite=Lax"),", разрешая отправлять ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," на верхнем уровне навигации. Давайте посетим страницу с постом о котэ, перейдя на нее с другого сайта по ссылке на оригинальный пост. Другой сайт может использовать фото котэ с вашего сайта напрямую и предоставить ссылку на оригинальный пост. "),Object(c.mdx)("pre",{className:"shiki",style:{backgroundColor:"#0F111A"}},Object(c.mdx)("code",{parentName:"pre"},Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"<"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#F07178"}}),"p"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),">"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),"Look at this amazing cat!"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"</"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#F07178"}}),"p"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),">"),"\n",Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"<"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#F07178"}}),"img"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}})," "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFCB6B"}}),"src"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),'"'),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C3E88D"}}),"https://blog.example/blog/img/amazing-cat.png"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),'"'),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}})," />"),"\n",Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"<"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#F07178"}}),"p"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),">"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),"Read the "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"<"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#F07178"}}),"a"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}})," "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFCB6B"}}),"href"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),'"'),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C3E88D"}}),"https://blog.example/blog/cat.html"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),'"'),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),">"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),"article"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"</"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#F07178"}}),"a"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),">"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),"."),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"</"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#F07178"}}),"p"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),">"))),Object(c.mdx)("p",null,"А ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," установлен следующим образом:"),Object(c.mdx)("pre",{className:"shiki",style:{backgroundColor:"#0F111A"}},Object(c.mdx)("code",{parentName:"pre"},Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFCB6B"}}),"Set"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"-"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Cookie"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),": "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"promo_shown"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#F78C6C"}}),"1"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),";"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}})," "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"SameSite"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Lax"))),Object(c.mdx)("p",null,"Когда пользователь придет на другой сайт,",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," не будет прикреплен к запросу на получение ",Object(c.mdx)("inlineCode",{parentName:"p"},"amazing-cat.png"),". Однако при переходе по ссылке к оригинальному посту ",Object(c.mdx)("inlineCode",{parentName:"p"},"cat.html")," в вашем блоге, запрос будет включать ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie"),". Это делает ",Object(c.mdx)("inlineCode",{parentName:"p"},"Lax")," хорошим выбором для ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," влияющих на отображение, тогда как ",Object(c.mdx)("inlineCode",{parentName:"p"},"Strict")," полезен для ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies"),", которые относятся к действиям пользователя"),Object(c.mdx)("p",null,Object(c.mdx)("strong",{parentName:"p"},"Предупреждение:")),Object(c.mdx)("p",null,"Ни ",Object(c.mdx)("inlineCode",{parentName:"p"},"Strict")," ни ",Object(c.mdx)("inlineCode",{parentName:"p"},"Lax")," не являются полноценным решением для обеспечения безопасности сайта. ",Object(c.mdx)("inlineCode",{parentName:"p"},"Cookies")," отправляются как часть запросов пользователя и с ними нужно обращаться также как и с другими пользовательскими данными. Нужно следить за чистотой и корректностью передаваемых данных. Никогда не используйте ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," для хранения секретных данных со стороны сервера."),Object(c.mdx)("p",null,"Наконец, есть вариант не определять значение, что подразумевает собой отправку ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," во всех контекстах. В последнем черновике спецификации RFC6265bis это можно сделать явно определив ",Object(c.mdx)("inlineCode",{parentName:"p"},"SameSite=None"),". Это означает что можно использовать ",Object(c.mdx)("inlineCode",{parentName:"p"},"None")," если вы намеренно хотите отправлять ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," сторонним сайтам."),Object(c.mdx)(o.a,{url:"same-cookies/samesite-none-lax-strict.png",title:"Определяйте контекст использования cookie явно, через: None, Lax, или Strict.",mdxType:"Picture"}),Object(c.mdx)("p",null,"Если вы предоставляете сервис, которые другие сайты добавляют как виджет, встраиваемое содержимое, рекламу, или вам необходимо поддержка авторизации на разных сайтах, необходимо использовать ",Object(c.mdx)("inlineCode",{parentName:"p"},"None"),", чтобы ваши намерения были ясны."),Object(c.mdx)("h2",null,"Изменения в стандартном поведении без SameSite"),Object(c.mdx)("p",null,"Несмотря на то, что аттрибут ",Object(c.mdx)("inlineCode",{parentName:"p"},"SameSite")," широко поддерживается, он, к сожалению, мало используется разработчиками. По умолчанию, такое открытое поведение при отправке ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies"),", позволит во всех случаях их использовать, но при этом сделает пользователя уязвимым для CSRF атак и непредвиденных утечек личной информации. Чтобы обязать разработчиков явно заявлять о намерениях при использовании ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," и предоставлять пользователям более безопасные приложения, Инженерный Совет Интернета (IETF - Internet Engineering Task Force) предложил улучшение работы с ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," с двумя изменениями:"),Object(c.mdx)("ul",null,Object(c.mdx)("li",{parentName:"ul"},Object(c.mdx)("p",{parentName:"li"},Object(c.mdx)("strong",{parentName:"p"},Object(c.mdx)("inlineCode",{parentName:"strong"},"Cookies")," без атрибута ",Object(c.mdx)("inlineCode",{parentName:"strong"},"SameSite")," трактуются как: ",Object(c.mdx)("inlineCode",{parentName:"strong"},"SameSite=Lax"),"."))),Object(c.mdx)("li",{parentName:"ul"},Object(c.mdx)("p",{parentName:"li"},Object(c.mdx)("strong",{parentName:"p"},Object(c.mdx)("inlineCode",{parentName:"strong"},"Cookies")," с атрибутом ",Object(c.mdx)("inlineCode",{parentName:"strong"},"SameSite=None")," должны также содержать аттрибут ",Object(c.mdx)("inlineCode",{parentName:"strong"},"Secure"),", и передаваться только по защищенному протоколу.")))),Object(c.mdx)("p",null,"Chrome добавил эти изменения начиная с версии 84. В Firefox они тестируются с версии 69 и в дальнейшем будут активны по умолчанию. Чтобы протестировать эти изменения в Firefox, откройте ",Object(c.mdx)("inlineCode",{parentName:"p"},"about:config")," и включите опцию ",Object(c.mdx)("inlineCode",{parentName:"p"},"network.cookie.sameSite.laxByDefault"),". Edge также планирует изменить свое стандартное поведение."),Object(c.mdx)("h2",null,Object(c.mdx)("inlineCode",{parentName:"h2"},"SameSite=Lax")," по умолчанию"),Object(c.mdx)("p",null,"Атрибут не выбран:"),Object(c.mdx)("pre",{className:"shiki",style:{backgroundColor:"#0F111A"}},Object(c.mdx)("code",{parentName:"pre"},Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFCB6B"}}),"Set"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"-"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Cookie"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),": "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"promo_shown"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#F78C6C"}}),"1"))),Object(c.mdx)("p",null,"Если вы отправите ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," без аттрибута ",Object(c.mdx)("inlineCode",{parentName:"p"},"SameSite"),"…"),Object(c.mdx)("p",null,"Применится стандартное поведение:"),Object(c.mdx)("pre",{className:"shiki",style:{backgroundColor:"#0F111A"}},Object(c.mdx)("code",{parentName:"pre"},Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFCB6B"}}),"Set"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"-"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Cookie"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),": "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"promo_shown"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#F78C6C"}}),"1"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),";"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}})," "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"SameSite"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Lax"))),Object(c.mdx)("p",null,"Браузер будет работать с ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," как при ",Object(c.mdx)("inlineCode",{parentName:"p"},"SameSite=Lax"),"."),Object(c.mdx)("p",null,"Даже несмотря на то что теперь предоставляется более безопасное поведение по умолчанию, вам лучше явно определить ",Object(c.mdx)("inlineCode",{parentName:"p"},"SameSite"),", чем предоставить это решение браузеру. Это сделает ваши намерения в отношении ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," прозрачными и улучшит кросс-браузерную поддержку."),Object(c.mdx)("p",null,Object(c.mdx)("strong",{parentName:"p"},"Внимание:")),Object(c.mdx)("p",null,"Стандартное поведение Chrome чуть менее строгое чем явный ",Object(c.mdx)("inlineCode",{parentName:"p"},"SameSite=Lax"),", поскольку разрешена отправка некоторых ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," для POST запросов верхнего уровня. Подробнее об этом можно узнать здесь. Это временное снижение ограничений, если вам нужно передавать ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," сторонним сайтам, необходимо использовать: ",Object(c.mdx)("inlineCode",{parentName:"p"},"SameSite=None; Secure"),"."),Object(c.mdx)("h2",null,Object(c.mdx)("inlineCode",{parentName:"h2"},"SameSite=None")," должны быть безопасными"),Object(c.mdx)("p",null,"Отклонено:"),Object(c.mdx)("pre",{className:"shiki",style:{backgroundColor:"#0F111A"}},Object(c.mdx)("code",{parentName:"pre"},Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFCB6B"}}),"Set"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"-"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Cookie"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),": "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"widget_session"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"abc123"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),";"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}})," "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"SameSite"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"None"))),Object(c.mdx)("p",null,"Назначение ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie")," без ",Object(c.mdx)("inlineCode",{parentName:"p"},"Secure")," будет отклонено."),Object(c.mdx)("p",null,"Принято:"),Object(c.mdx)("pre",{className:"shiki",style:{backgroundColor:"#0F111A"}},Object(c.mdx)("code",{parentName:"pre"},Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFCB6B"}}),"Set"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"-"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Cookie"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}}),": "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"widget_session"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"abc123"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),";"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}})," "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"SameSite"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"None"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),";"),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}})," "),Object(c.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"Secure"))),Object(c.mdx)("p",null,"Вы должны быть уверены что аттрибут ",Object(c.mdx)("inlineCode",{parentName:"p"},"SameSite=None")," используется в паре с аттрибутом ",Object(c.mdx)("inlineCode",{parentName:"p"},"Secure"),"."),Object(c.mdx)("p",null,"Вы можете протестировать это поведение с версии Chrome 76 включив ",Object(c.mdx)("inlineCode",{parentName:"p"},"chrome://flags/#cookies-without-same-site-must-be-secure")," и в Firefox 69 в ",Object(c.mdx)("inlineCode",{parentName:"p"},"about:config"),", установив ",Object(c.mdx)("inlineCode",{parentName:"p"},"network.cookie.sameSite.noneRequiresSecure"),"."),Object(c.mdx)("p",null,"Вам нужно их применить, когда вы устанавливаете новые ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," и активно обновляете существующие ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookies")," даже если не истек их срок действия."),Object(c.mdx)("p",null,"Если вы зависите от сервисов, которые предоставляют сторонний контент на вашем сайте, вы также должны следить за тем что они обновляют свое поведение. Вам необходимо обновлять зависимости,чтобы быть уверенным, что ваш сайт поддерживает новое поведение."),Object(c.mdx)("p",null,"Оба этих изменения обратно-совместимы с браузерами, которые корректно воспроизводят предыдущую версию аттрибута ",Object(c.mdx)("inlineCode",{parentName:"p"},"SameSite")," или вообще ее не поддерживают. Аналогично, любые клиенты не поддерживающие ",Object(c.mdx)("inlineCode",{parentName:"p"},"SameSite=None")," до сих пор, должны игнорировать его и обрабатывать таким образом, как будто этот аттрибут не задан."),Object(c.mdx)("p",null,"Предупреждение:"),Object(c.mdx)("p",null,"Определенное число старых версий браузеров Chrome, Safari, и UC несовместимы с новым значением ",Object(c.mdx)("inlineCode",{parentName:"p"},"None")," и могут игнорировать или отклонять ",Object(c.mdx)("inlineCode",{parentName:"p"},"cookie"),". Это поведение исправлено в текущих версиях, но необходимо проверить соотношение пользователей использующих старые версии. Список неподдерживаемых клиентов можно найти на сайте Chromium."),Object(c.mdx)("p",null,"Огромное спасибо за участие и обратную связь Lily Chen, Malte Ubl, Mike West, Rob Dodson, Tom Steiner, и Vivek Sekhar"))}d.isMDXComponent=!0},zLVn:function(e,t,a){"use strict";function n(e,t){if(null==e)return{};var a,n,c={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(c[a]=e[a]);return c}a.d(t,"a",(function(){return n}))}}]);
//# sourceMappingURL=component---src-pages-posts-same-cookies-mdx-b2db131886c5a90baf2f.js.map