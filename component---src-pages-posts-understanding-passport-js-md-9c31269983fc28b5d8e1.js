(window.webpackJsonp=window.webpackJsonp||[]).push([[12,14],{ZyDG:function(e,t,n){"use strict";n.r(t),n.d(t,"_frontmatter",(function(){return r})),n.d(t,"default",(function(){return i}));var a=n("zLVn"),p=(n("q1tI"),n("7ljp")),r={title:"Разбираемся с процессом авторизации в passport.js",date:"2020-10-04",tags:["js"]},m={_frontmatter:r};function i(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(p.mdx)("wrapper",Object.assign({},m,n,{components:t,mdxType:"MDXLayout"}),Object(p.mdx)("h1",null,"Разбираемся с процессом авторизации в ",Object(p.mdx)("inlineCode",{parentName:"h1"},"passport.js")),Object(p.mdx)("p",null,"Перевод статьи ",Object(p.mdx)("a",Object.assign({parentName:"p"},{href:"http://toon.io/understanding-passportjs-authentication-flow/"}),"Understanding passport.js authentication flow")),Object(p.mdx)("p",null,"Passport.js - миддлвар для авторизации (позволяющий пользователям логиниться), который может быть полностью кастомизирован и отлично работает в связке с connect/express."),Object(p.mdx)("p",null,"Он является довольно гибким в том смысле, что позволяет использовать разные стратегии авторизации (допустим через Twitter, или с помощью собственной базы данных - за счет установки отдельных модулей и их комбинирования), а также ",Object(p.mdx)("strong",{parentName:"p"},"passport.js")," позволяет определить маршрут или вывод результата авторизации."),Object(p.mdx)("p",null,"Стратегия ",Object(p.mdx)("strong",{parentName:"p"},Object(p.mdx)("inlineCode",{parentName:"strong"},"Local Strategy"))," позволяет пользователям авторизоваться, используя базу данных приложения. Для этих случаев есть несколько отличных примеров."),Object(p.mdx)("p",null,"В этой статье, мы разберемся с процессом авторизации, а в следующей разберем несколько практических сценариев использования ",Object(p.mdx)("strong",{parentName:"p"},Object(p.mdx)("inlineCode",{parentName:"strong"},"passportjs")),"."),Object(p.mdx)("h2",null,"Основные моменты при использовании ",Object(p.mdx)("inlineCode",{parentName:"h2"},"passport.js")),Object(p.mdx)("p",null,"Есть 3 момента при использовании ",Object(p.mdx)("strong",{parentName:"p"},Object(p.mdx)("inlineCode",{parentName:"strong"},"passport.js")),":"),Object(p.mdx)("ol",null,Object(p.mdx)("li",{parentName:"ol"},"Импортируем модуль и вызываем методы ",Object(p.mdx)("inlineCode",{parentName:"li"},"passport.initialize()")," и ",Object(p.mdx)("inlineCode",{parentName:"li"},"passport.session()")," для миддлвары express."),Object(p.mdx)("li",{parentName:"ol"},"Настраиваем для ",Object(p.mdx)("inlineCode",{parentName:"li"},"passport")," хотя бы одну стратегию ",Object(p.mdx)("inlineCode",{parentName:"li"},"Strategy")," и подключаем методы ",Object(p.mdx)("inlineCode",{parentName:"li"},"passport")," ",Object(p.mdx)("inlineCode",{parentName:"li"},"serializeUser")," and ",Object(p.mdx)("inlineCode",{parentName:"li"},"deserializeUser"),"."),Object(p.mdx)("li",{parentName:"ol"},"Определяем маршрут, в котором будем использовать миддлвар ",Object(p.mdx)("inlineCode",{parentName:"li"},"passport.authenticate")," непосредственно для авторизации пользователя.")),Object(p.mdx)("p",null,"Примеры в документации достаточно ясно показывают использование этих методов. Поэтому,подробнее здесь мы их не рассматриваем."),Object(p.mdx)("h2",null,"Процесс запроса на авторизацию"),Object(p.mdx)("p",null,"Итак, если мы верно настроили ",Object(p.mdx)("inlineCode",{parentName:"p"},"passportjs"),", согласно примеру выше, то при попытке пользователя авторизоваться по маршруту ",Object(p.mdx)("a",Object.assign({parentName:"p"},{href:"/dev-docs/login"}),"/login"),", произойдет следующее:"),Object(p.mdx)("ul",null,Object(p.mdx)("li",{parentName:"ul"},"Когда пользователь отправит данные формы авторизации, ",Object(p.mdx)("inlineCode",{parentName:"li"},"POST")," запрос к маршруту ",Object(p.mdx)("a",Object.assign({parentName:"li"},{href:"/dev-docs/login"}),"/login")," вызовет выполнение мидлвар ",Object(p.mdx)("inlineCode",{parentName:"li"},"passport.authenticate"),", который мы подключили.\n"),Object(p.mdx)("li",{parentName:"ul"},"Поскольку миддлвар авторизации для этого маршрута настроен на использование стратегии ",Object(p.mdx)("inlineCode",{parentName:"li"},"LocalStrategy"),", ",Object(p.mdx)("inlineCode",{parentName:"li"},"passport")," вызовет нашу реализацию ",Object(p.mdx)("inlineCode",{parentName:"li"},"LocalStrategy"),".\n"),Object(p.mdx)("li",{parentName:"ul"},Object(p.mdx)("inlineCode",{parentName:"li"},"Passport")," возьмет из запроса ",Object(p.mdx)("inlineCode",{parentName:"li"},"req.body.username")," и ",Object(p.mdx)("inlineCode",{parentName:"li"},"req.body.password")," и передаст их нашей функции проверки авторизации в ",Object(p.mdx)("inlineCode",{parentName:"li"},"LocalStrategy"),".\n"),Object(p.mdx)("li",{parentName:"ul"},"Теперь займемся своими делами: загрузим данные пользователя из базы данных и проверим совпадают ли пароли.\n")),Object(p.mdx)("p",null,"В случае если при взаимодействии с базой данных сработает ошибка, нам нужно передать ее методу ",Object(p.mdx)("inlineCode",{parentName:"p"},"done(err)"),". "),Object(p.mdx)("p",null,"Когда мы не можем найти пользователя или пароли не совпали, мы вызываем ",Object(p.mdx)("inlineCode",{parentName:"p"},"done(null, false)"),". "),Object(p.mdx)("p",null,"Если же все прошло хорошо, и мы хотим залогинить пользователя, вызываем ",Object(p.mdx)("inlineCode",{parentName:"p"},"done(null, user)"),"."),Object(p.mdx)("p",null,"Вызов ",Object(p.mdx)("inlineCode",{parentName:"p"},"done")," позволит последовательности авторизации перепрыгнуть обратно в ",Object(p.mdx)("inlineCode",{parentName:"p"},"passport.authenticate"),". Передаются ошибка ",Object(p.mdx)("inlineCode",{parentName:"p"},"error"),", ",Object(p.mdx)("inlineCode",{parentName:"p"},"user")," и объект с дополнительной информацией (если он был определен)."),Object(p.mdx)("p",null,"Если объект ",Object(p.mdx)("inlineCode",{parentName:"p"},"user")," был передан, миддлвар  вызовет ",Object(p.mdx)("inlineCode",{parentName:"p"},"req.login")," (метод ",Object(p.mdx)("inlineCode",{parentName:"p"},"passport"),", добавленный к запросу ",Object(p.mdx)("inlineCode",{parentName:"p"},"request"),")."),Object(p.mdx)("p",null,"Это приведет к вызову  метода ",Object(p.mdx)("inlineCode",{parentName:"p"},"passport.serializeUser"),", который мы определили ранее. "),Object(p.mdx)("p",null,"Этот метод имеет доступ к объекту ",Object(p.mdx)("inlineCode",{parentName:"p"},"user"),", который мы передали в миддлвар."),Object(p.mdx)("p",null,"Его работа заключается в том, чтобы определить, какие данные объекта ",Object(p.mdx)("inlineCode",{parentName:"p"},"user")," должны быть записаны в сессии ",Object(p.mdx)("inlineCode",{parentName:"p"},"session"),". "),Object(p.mdx)("p",null,"Результат выполнения метода ",Object(p.mdx)("inlineCode",{parentName:"p"},"serializeUser")," прикрепляется к сессии: "),Object(p.mdx)("pre",{className:"shiki",style:{backgroundColor:"#0F111A"}},Object(p.mdx)("code",{parentName:"pre"},Object(p.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"req"),Object(p.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"."),Object(p.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"session"),Object(p.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"."),Object(p.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"passport"),Object(p.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"."),Object(p.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#8F93A2"}}),"user"),Object(p.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}})," "),Object(p.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#C792EA"}}),"="),Object(p.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}})," "),Object(p.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#89DDFF"}}),"{"),Object(p.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#FFFFFF"}})," "),Object(p.mdx)("span",Object.assign({parentName:"code"},{style:{color:"#464B5D"}}),"// our serialised user object // }."))),Object(p.mdx)("p",null,"Результат также прикреплен к запросу: ",Object(p.mdx)("inlineCode",{parentName:"p"},"req.user"),"."),Object(p.mdx)("p",null,"Когда все это выполнено, вызывается наш обработчик запросов ",Object(p.mdx)("inlineCode",{parentName:"p"},"requestHandler"),". В данном примере поьзователь будет перенаправлен на стартовую страницу."),Object(p.mdx)("h2",null,"Последовательность последующих запросов авторизации"),Object(p.mdx)("p",null,"При последующих запросах, произойдет следующее:"),Object(p.mdx)("ul",null,Object(p.mdx)("li",{parentName:"ul"},Object(p.mdx)("p",{parentName:"li"},Object(p.mdx)("strong",{parentName:"p"},"Express")," загрузит данные сессии и прикрепит их к запросу ",Object(p.mdx)("inlineCode",{parentName:"p"},"req"),". Так как ",Object(p.mdx)("strong",{parentName:"p"},"passport")," записал выбранные данные пользователя в сессию, сериализованный объект ",Object(p.mdx)("inlineCode",{parentName:"p"},"user")," можно будет найти в ",Object(p.mdx)("inlineCode",{parentName:"p"},"req.session.passport.user"),".")),Object(p.mdx)("li",{parentName:"ul"},Object(p.mdx)("p",{parentName:"li"},"Основной миддлвар ",Object(p.mdx)("inlineCode",{parentName:"p"},"passport"),", который мы настроили (",Object(p.mdx)("strong",{parentName:"p"},Object(p.mdx)("inlineCode",{parentName:"strong"},"passport.initialize")),") будет вызван при запросе, он найдет ",Object(p.mdx)("inlineCode",{parentName:"p"},"passport.user")," прикрепленный к сессии. Если он отсутствует (пользователь еще не авторизовался), то будет создан в следующем виде: ",Object(p.mdx)("inlineCode",{parentName:"p"},"req.passport.user = {}"),".")),Object(p.mdx)("li",{parentName:"ul"},Object(p.mdx)("p",{parentName:"li"},"Затем, будет вызван ",Object(p.mdx)("inlineCode",{parentName:"p"},"passport.session"),". Этот миддлвар - часть стратегии ",Object(p.mdx)("inlineCode",{parentName:"p"},"Passport Strategy"),", вызываемой при каждом запросе. Если он найдет сериализованный объект пользователя ",Object(p.mdx)("inlineCode",{parentName:"p"},"user")," в сессии, он решит, что запрос ",Object(p.mdx)("inlineCode",{parentName:"p"},"request")," авторизован.")),Object(p.mdx)("li",{parentName:"ul"},Object(p.mdx)("p",{parentName:"li"},"Миддлвар ",Object(p.mdx)("inlineCode",{parentName:"p"},"passport.session")," вызовет ",Object(p.mdx)("inlineCode",{parentName:"p"},"passport.deserializeUser"),", который мы добавили ранее. Тем самым, прикрепляя загруженный объект ",Object(p.mdx)("inlineCode",{parentName:"p"},"user")," к запросу в виде ",Object(p.mdx)("inlineCode",{parentName:"p"},"req.user"),"."))),Object(p.mdx)("h2",null,"Итого: все методы и мидллвары ",Object(p.mdx)("inlineCode",{parentName:"h2"},"passport")),Object(p.mdx)("ol",null,Object(p.mdx)("li",{parentName:"ol"},Object(p.mdx)("p",{parentName:"li"},Object(p.mdx)("strong",{parentName:"p"},Object(p.mdx)("inlineCode",{parentName:"strong"},"passport.initialize"))," миддлвар вызывается на каждый запрос. Убеждается что сессия содержит ",Object(p.mdx)("inlineCode",{parentName:"p"},"passport.user objec t"),", который может быть пустым.")),Object(p.mdx)("li",{parentName:"ol"},Object(p.mdx)("p",{parentName:"li"},Object(p.mdx)("strong",{parentName:"p"},Object(p.mdx)("inlineCode",{parentName:"strong"},"passport.session"))," миддлвар - часть стратегии ",Object(p.mdx)("inlineCode",{parentName:"p"},"Passport Strategy"),": загружает объект пользователя ",Object(p.mdx)("inlineCode",{parentName:"p"},"user")," в ",Object(p.mdx)("inlineCode",{parentName:"p"},"req.user")," , если сериализованный объект найден на сервере.")),Object(p.mdx)("li",{parentName:"ol"},Object(p.mdx)("p",{parentName:"li"},Object(p.mdx)("strong",{parentName:"p"},Object(p.mdx)("inlineCode",{parentName:"strong"},"passport.deserializeUser"))," вызывается на каждый запрос из миддлвара ",Object(p.mdx)("strong",{parentName:"p"},Object(p.mdx)("inlineCode",{parentName:"strong"},"passport.session")),". Это позволяет нам подгружать дополнительную информацию пользователя при каждом запросе. Этот объект пользователя ",Object(p.mdx)("inlineCode",{parentName:"p"},"user")," будет прикреплен к запросу в виде ",Object(p.mdx)("inlineCode",{parentName:"p"},"req.user"),", чтобы можно было получить к нему доступ при обработке запросов.")),Object(p.mdx)("li",{parentName:"ol"},Object(p.mdx)("p",{parentName:"li"},"Наша локальная стратегия ",Object(p.mdx)("inlineCode",{parentName:"p"},"Local Strategy")," вызывается только при использовании маршрута который содержит миддлвар ",Object(p.mdx)("strong",{parentName:"p"},Object(p.mdx)("inlineCode",{parentName:"strong"},"passport.authenticate")),".")),Object(p.mdx)("li",{parentName:"ol"},Object(p.mdx)("p",{parentName:"li"},"Только при авторизации вызывается ",Object(p.mdx)("strong",{parentName:"p"},Object(p.mdx)("inlineCode",{parentName:"strong"},"passport.serializeUser"))," позволяя нам определить какая информация пользователя будет записана в сессии."))),Object(p.mdx)("h4",null,"Методы ",Object(p.mdx)("inlineCode",{parentName:"h4"},"passport")," прикрепленные к запросу  ",Object(p.mdx)("inlineCode",{parentName:"h4"},"request")),Object(p.mdx)("p",null,"Ну и наконец обзор методов ",Object(p.mdx)("inlineCode",{parentName:"p"},"passport")," доступных внутри обработчиков запросов:"),Object(p.mdx)("ul",null,Object(p.mdx)("li",{parentName:"ul"},Object(p.mdx)("inlineCode",{parentName:"li"},"req.login()")),Object(p.mdx)("li",{parentName:"ul"},Object(p.mdx)("inlineCode",{parentName:"li"},"req.logout()")),Object(p.mdx)("li",{parentName:"ul"},Object(p.mdx)("inlineCode",{parentName:"li"},"req.isAuthenticated()")),Object(p.mdx)("li",{parentName:"ul"},Object(p.mdx)("inlineCode",{parentName:"li"},"req.isUnAuthenticated()"))))}i.isMDXComponent=!0},zLVn:function(e,t,n){"use strict";function a(e,t){if(null==e)return{};var n,a,p={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(p[n]=e[n]);return p}n.d(t,"a",(function(){return a}))}}]);
//# sourceMappingURL=component---src-pages-posts-understanding-passport-js-md-9c31269983fc28b5d8e1.js.map